<html>
    <head>
      <meta name="viewport" content="width=device-width, initial-scale=1">
      <link rel="icon" href="data:,">
      <link rel="stylesheet" type="text/css" href="/css/app.css">
        
      <title>CANServer</title>
      <script src="/js/app.js"></script>
      
    </head>
    <body>
      <main id="main">
        <h1>CANServer</h1>
        <h4>Status</h4>
        <p>Build Date: %BUILD_DATE%</p>
        
        <br>
  
        <h4>Utilities</h4>
        <button onclick="fetch('/restart');">Restart</button>


        <form method='POST' action='#' enctype='multipart/form-data' id='upload_form'>          
          <input type='file' name='update' id='update_file'>
          <button>Update</button><br>
          <span id="update_status" class="hidden"></span><br>
          <progress id="update_progress" max="100" value="0" class="hidden"></progress>

        </form>

        <script>
        
        document.getElementById('upload_form').onsubmit = function (e) { uploadUpdate(e, this) };
        
        const updateError = () => {
          alert('Please select a single file to update.  Either firmware.bin or spiffs.bin');
        }
        
        const uploadUpdate = (e, theForm) => {
            e.preventDefault();
            
            fileList = document.getElementById('update_file').files;
            
            if (fileList.length != 1) {
              updateError();
              return;
            }
            else
            {
              var updateURL = "/update";
              startingMessage = "Uploading...";
              //Check the filename and make sure it is one we support
              if (fileList[0].name == "firmware.bin") {
                updateURL = "/update";
                startingMessage = "Uploading firmware...";
              } else if (fileList[0].name == "spiffs.bin") {
                updateURL = "/update_spiffs";
                startingMessage = "Uploading spiffs...";
              } else {
                updateError();
                return;
              }
              
              var progressEl = document.getElementById('update_progress');
              progressEl.value = 0;
              show(progressEl);
              
              var statusEl = document.getElementById('update_status');
              statusEl.innerText = startingMessage;
              show(statusEl);
              removeClass(statusEl, 'bad');
              removeClass(statusEl, 'good');
              
              var request = new XMLHttpRequest();
              request.open('post', updateURL); 

              request.upload.addEventListener('progress', function(e) {
                var percent_complete = (e.loaded / e.total) * 100;

                progressEl.value = percent_complete;
                
                if (percent_complete >= 100)
                {
                  //Upload complete.  Flashing now.
                  statusEl.innerText = 'Flashing...';
                  progressEl.removeAttribute('value');
                }
              });

              // AJAX request finished event
              request.addEventListener('load', function(e) {
              	if (request.status == 200) {
              	  //update completed.  Board is restarting...
              	  statusEl.innerText = 'Update complete!  CANServer is restarting.';
              	  addClass(statusEl, 'good');
              	} else {
              	  //update failed. 
              	  statusEl.innerText = 'Update failed.';
              	  addClass(statusEl, 'bad');
              	}
              	
              	hide(progressEl);
              });
              
              // send POST request to server side script
              var data = new FormData(theForm);
              request.send(data);
            }
          }
        </script>
      </main>
    </body>
</html>